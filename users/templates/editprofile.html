{% extends "base.html" %}
{% load static %}

{% block title %}Edit Profile ‚Äî Oliminate{% endblock %}

{% block content %}
<div class="container" style="padding: 36px 0;">
  <div class="card" style="display:flex; gap:28px; align-items:flex-start; border-radius:16px; padding:28px;">
    <!-- LEFT: Avatar -->
    <div style="width:220px; display:flex; flex-direction:column; align-items:center; gap:12px;">
      <div id="avatarWrap" style="width:160px; height:160px; border-radius:999px; overflow:hidden; background:var(--pacil-blue-lighter-3); display:flex; align-items:center; justify-content:center;">
        <img id="avatarImg" alt="Foto profil" style="width:100%; height:100%; object-fit:cover; display:block;"
             src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' fill='%23E5F1FB'/><circle cx='80' cy='60' r='34' fill='%23AED4F7' /><rect x='32' y='100' rx='8' width='96' height='26' fill='%23AED4F7' /></svg>">
      </div>

      <div style="display:flex; gap:8px; flex-direction:column; align-items:center; width:100%;">
        <button type="button" id="editPfpBtn" class="btn" style="border:1px solid var(--neutral-100); width:100%;">Edit PFP</button>
        <input id="fileInput" name="avatar" type="file" accept="image/*" style="display:none;">
        <p class="small" style="text-align:center; margin:0;">Maks 2MB ‚Ä¢ JPG / PNG</p>
      </div>
    </div>

    <!-- RIGHT: Form -->
    <form id="profileForm" method="post" enctype="multipart/form-data" style="flex:1;">
      {% csrf_token %}
      <h3 class="h3" style="margin-top:0;">Edit Profile</h3>

      <div style="margin-bottom:14px;">
        <label for="name" class="caption">Nama</label>
        <input id="name" name="name" type="text" class="body" placeholder="Nama lengkap" value="{{ user.get_full_name|default:'' }}" style="width:100%; height:44px; padding:10px 12px; border-radius:10px; border:1px solid var(--neutral-100);">
      </div>

      <div style="margin-bottom:14px;">
        <label for="email" class="caption">Email</label>
        <input id="email" name="email" type="email" class="body" placeholder="contoh@email.com" value="{{ user.email|default:'' }}" style="width:100%; height:44px; padding:10px 12px; border-radius:10px; border:1px solid var(--neutral-100);">
      </div>

      <!-- NEW: Fakultas -->
      <div style="margin-bottom:14px;">
        <label for="fakultas" class="caption">Fakultas</label>
        <select id="fakultas" name="fakultas" class="body" style="width:100%; height:44px; padding:8px 12px; border-radius:10px; border:1px solid var(--neutral-100); background:white;">
          <option value="">Pilih Fakultas...</option>

          <option value="Kedokteran" {% if user.profile.fakultas == "Kedokteran" %}selected{% endif %}>Kedokteran</option>
          <option value="Kedokteran Gigi" {% if user.profile.fakultas == "Kedokteran Gigi" %}selected{% endif %}>Kedokteran Gigi</option>
          <option value="Matematika dan Ilmu Pengetahuan Alam" {% if user.profile.fakultas == "Matematika dan Ilmu Pengetahuan Alam" %}selected{% endif %}>Matematika dan Ilmu Pengetahuan Alam</option>
          <option value="Teknik" {% if user.profile.fakultas == "Teknik" %}selected{% endif %}>Teknik</option>
          <option value="Hukum" {% if user.profile.fakultas == "Hukum" %}selected{% endif %}>Hukum</option>
          <option value="Ekonomi dan Bisnis" {% if user.profile.fakultas == "Ekonomi dan Bisnis" %}selected{% endif %}>Ekonomi dan Bisnis</option>
          <option value="Ilmu Pengetahuan Budaya" {% if user.profile.fakultas == "Ilmu Pengetahuan Budaya" %}selected{% endif %}>Ilmu Pengetahuan Budaya</option>
          <option value="Psikologi" {% if user.profile.fakultas == "Psikologi" %}selected{% endif %}>Psikologi</option>
          <option value="Ilmu Sosial dan Ilmu Politik" {% if user.profile.fakultas == "Ilmu Sosial dan Ilmu Politik" %}selected{% endif %}>Ilmu Sosial dan Ilmu Politik</option>
          <option value="Kesehatan Masyarakat" {% if user.profile.fakultas == "Kesehatan Masyarakat" %}selected{% endif %}>Kesehatan Masyarakat</option>
          <option value="Ilmu Komputer" {% if user.profile.fakultas == "Ilmu Komputer" %}selected{% endif %}>Ilmu Komputer</option>
          <option value="Ilmu Keperawatan" {% if user.profile.fakultas == "Ilmu Keperawatan" %}selected{% endif %}>Ilmu Keperawatan</option>
          <option value="Pendidikan Vokasi" {% if user.profile.fakultas == "Pendidikan Vokasi" %}selected{% endif %}>Pendidikan Vokasi</option>
          <option value="Farmasi" {% if user.profile.fakultas == "Farmasi" %}selected{% endif %}>Farmasi</option>
          <option value="Ilmu Administrasi" {% if user.profile.fakultas == "Ilmu Administrasi" %}selected{% endif %}>Ilmu Administrasi</option>
          <option value="Ilmu Lingkungan" {% if user.profile.fakultas == "Ilmu Lingkungan" %}selected{% endif %}>Ilmu Lingkungan</option>
        </select>
        <p class="small" style="margin:6px 0 0;">Pilih fakultasmu. (Opsional ‚Äî kosongkan bila tidak relevan)</p>
      </div>

      <div style="margin-bottom:18px;">
        <label for="password" class="caption">Password</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="password" name="password" type="password" class="body" placeholder="Kosongkan jika tidak ingin mengganti" style="flex:1; height:44px; padding:10px 12px; border-radius:10px; border:1px solid var(--neutral-100);">
          <button id="togglePwd" type="button" class="btn" style="min-width:44px; padding:8px; border-radius:8px; border:1px solid var(--neutral-100);">üëÅÔ∏è</button>
        </div>
        <p class="small" style="margin:6px 0 0;">Biarkan kosong bila tidak ingin mengubah password.</p>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:8px;">
        <button id="cancelBtn" type="button" class="btn btn-outline">Cancel</button>
        <button id="saveBtn" type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast (simple) -->
<div id="toast" style="position:fixed; right:18px; bottom:18px; background:var(--neutral-900); color:var(--neutral-50); padding:10px 14px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.18); opacity:0; transform:translateY(12px); transition:all .22s ease;">Saved</div>

<!-- JS: preview avatar, toggle password, cancel restore, basic validation -->
<script>
  (function(){
    const editBtn = document.getElementById('editPfpBtn');
    const fileInput = document.getElementById('fileInput');
    const avatarImg = document.getElementById('avatarImg');
    const profileForm = document.getElementById('profileForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const togglePwd = document.getElementById('togglePwd');
    const toast = document.getElementById('toast');
    const fakultasEl = document.getElementById('fakultas');

    // snapshot original values to restore on cancel
    const original = {
      avatar: avatarImg.src,
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      fakultas: fakultasEl ? fakultasEl.value : '',
      password: ''
    };

    editBtn.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (f.size > 2_000_000) {
        alert('File terlalu besar (maks 2MB). Pilih file lain.');
        fileInput.value = '';
        return;
      }
      const r = new FileReader();
      r.onload = () => avatarImg.src = r.result;
      r.readAsDataURL(f);
    });

    togglePwd.addEventListener('click', () => {
      const pwd = document.getElementById('password');
      pwd.type = (pwd.type === 'password') ? 'text' : 'password';
    });

    profileForm.addEventListener('submit', function(ev){
      // basic client validation
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const pwd = document.getElementById('password').value;
      if (!name) { alert('Nama tidak boleh kosong'); ev.preventDefault(); return; }
      if (!email || !/^\S+@\S+\.\S+$/.test(email)) { alert('Masukkan email yang valid'); ev.preventDefault(); return; }
      if (pwd && pwd.length < 6) { alert('Password minimal 6 karakter'); ev.preventDefault(); return; }

      // optionally you can check fakultas here, e.g. require it:
      // const fakultas = fakultasEl ? fakultasEl.value : '';
      // if(!fakultas){ alert('Pilih fakultas'); ev.preventDefault(); return; }

      // allow submit to server ‚Äî you can remove the simulated parts if posting to server
      showToast('Mengirim perubahan...');
      // note: if you want to submit via AJAX/fetch, prevent default and send FormData here.
    });

    cancelBtn.addEventListener('click', function(){
      document.getElementById('name').value = original.name;
      document.getElementById('email').value = original.email;
      document.getElementById('password').value = original.password;
      avatarImg.src = original.avatar;
      fileInput.value = '';
      if (fakultasEl) fakultasEl.value = original.fakultas;
      showToast('Perubahan dibatalkan');
    });

    function showToast(message='') {
      toast.textContent = message;
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(12px)';
      }, 2200);
    }
  })();
</script>
{% endblock %}
