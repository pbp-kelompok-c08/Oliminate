{% extends 'base.html' %}
{% load static %}
{% block title %}Atur Harga Event{% endblock %}

{% block content %}
<div class="container mx-auto mt-8 px-4">

  <!-- Grid dua kolom -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

    <!-- =============================== -->
    <!-- ===== 1. FORM ATUR HARGA ===== -->
    <!-- =============================== -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <form method="POST" class="p-6 md:p-8">
        {% csrf_token %}
        <h1 class="h3 mb-6">Atur Harga Event</h1>

        <!-- Pesan Sukses (jika ada) -->
        {% if messages %}
          <ul class="mb-4 space-y-2">
            {% for message in messages %}
              <li class="p-4 rounded-lg bg-green-100 text-green-700 body">
                {{ message }}
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        <!-- Field: Schedule -->
        <div class="mb-5">
          <label for="{{ form.schedule.id_for_label }}" class="block body mb-2 font-semibold">
            Pilih Event/Jadwal
          </label>
          {{ form.schedule }}
          {% if form.schedule.errors %}
            <p class="footnote text-red-600 mt-1">
              {{ form.schedule.errors|striptags }}
            </p>
          {% endif %}
        </div>

        <!-- Field: Price -->
        <div class="mb-5">
          <label for="{{ form.price.id_for_label }}" class="block body mb-2 font-semibold">
            Harga (Rp)
          </label>
          {{ form.price }}
          {% if form.price.errors %}
            <p class="footnote text-red-600 mt-1">
              {{ form.price.errors|striptags }}
            </p>
          {% endif %}
        </div>

        <!-- Tombol -->
        <div class="border-t border-gray-100 pt-6 mt-6 flex gap-3">
          <button type="button" id="save-btn" class="btn btn-primary flex-1">
            Simpan Harga
          </button>
          <button type="button" id="edit-btn" class="btn btn-primary flex-1" disabled>
            Edit Harga
          </button>
        </div>
      </form>
    </div>

    <!-- ================================== -->
    <!-- ===== 2. DAFTAR HARGA AKTIF ===== -->
    <!-- ================================== -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="p-6 md:p-8">
        <h2 class="h4 mb-4">Daftar Harga Saat Ini</h2>
        {% if prices %}
          <ul class="divide-y divide-gray-200">
            {% for p in prices %}
              <li class="py-3 flex justify-between items-center">
                <div>
                  <p class="body font-semibold">{{ p.schedule }}</p>
                  <p class="footnote text-gray-600">{{ p.schedule.date }}</p>
                </div>
                <span class="body text-blue-600 font-semibold">
                  Rp {{ p.price|floatformat:0 }}
                </span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="body text-gray-600">Belum ada harga yang diatur.</p>
        {% endif %}
      </div>
    </div>

  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const scheduleSelect = document.getElementById("id_schedule");
  const priceInput = document.getElementById("id_price");
  const saveBtn = document.getElementById("save-btn");
  const editBtn = document.getElementById("edit-btn");

  // Cek apakah event sudah punya harga
  scheduleSelect.addEventListener('change', function() {
    const scheduleId = this.value;
    if (!scheduleId) return;
    fetch(`/ticketing/get-price/${scheduleId}/`)
      .then(res => res.json())
      .then(data => {
        if (data.price > 0) {
          priceInput.value = data.price;
          saveBtn.disabled = true;
          editBtn.disabled = false;
        } else {
          priceInput.value = "";
          saveBtn.disabled = false;
          editBtn.disabled = true;
        }
      });
  });

  // Fungsi simpan harga baru atau edit harga
  function submitPrice() {
    const scheduleId = scheduleSelect.value;
    const price = priceInput.value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("/ticketing/set-price-ajax/", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfToken,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: new URLSearchParams({
        schedule_id: scheduleId,
        price: price,
      }),
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.querySelector(".bg-white.rounded-xl.shadow-lg.overflow-hidden:nth-child(2) .p-6").innerHTML = data.html;
      } else {
        alert(data.error);
      }
    });
  }

  saveBtn.addEventListener("click", submitPrice);
  editBtn.addEventListener("click", submitPrice);
});
</script>

{% endblock %}
