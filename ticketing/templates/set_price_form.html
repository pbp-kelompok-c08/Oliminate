{% extends 'base.html' %}
{% load static %}
{% block title %}Atur Harga Event{% endblock %}

{% block content %}
<div class="container mx-auto mt-8 px-4">

  <!-- Grid dua kolom -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

    <!-- =============================== -->
    <!-- ===== 1. FORM ATUR HARGA ===== -->
    <!-- =============================== -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <form method="POST" class="p-6 md:p-8">
        {% csrf_token %}
        <h1 class="h3 mb-6">Atur Harga Event</h1>

        <!-- Pesan Sukses (jika ada) -->
        <div id="messages-container">
          {% if messages %}
          <ul class="mb-4 space-y-2">
            {% for message in messages %}
            <li class="p-4 rounded-lg bg-green-100 text-green-700 body">
              {{ message }}
            </li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>

        <!-- Field: Schedule -->
        <div class="mb-5">
          <label for="{{ form.schedule.id_for_label }}" class="block body mb-2 font-semibold">
            Pilih Event/Jadwal
          </label>
          {{ form.schedule }}
          {% if form.schedule.errors %}
          <p class="footnote text-red-600 mt-1">
            {{ form.schedule.errors|striptags }}
          </p>
          {% endif %}
        </div>

        <!-- Field: Price -->
        <div class="mb-5">
          <label for="{{ form.price.id_for_label }}" class="block body mb-2 font-semibold">
            Harga (Rp)
          </label>
          {{ form.price }}
          {% if form.price.errors %}
          <p class="footnote text-red-600 mt-1">
            {{ form.price.errors|striptags }}
          </p>
          {% endif %}
        </div>

        <!-- Tombol -->
        <div class="border-t border-gray-100 pt-6 mt-6 flex gap-3">
          <button type="button" id="save-btn" class="btn btn-primary flex-1">
            Simpan Harga
          </button>
          <button type="button" id="edit-btn" class="btn btn-primary flex-1" disabled>
            Edit Harga
          </button>
        </div>
      </form>
    </div>

    <!-- ================================== -->
    <!-- ===== 2. DAFTAR HARGA AKTIF ===== -->
    <!-- ================================== -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="p-6 md:p-8">
        <div id="price-list-container">
          <h2 class="h4 mb-4">Daftar Harga Saat Ini</h2>
          {% if prices %}
          <ul class="divide-y divide-gray-200">
            {% for p in prices %}
            <li class="py-3 flex justify-between items-center">
              <div>
                <p class="body font-semibold">{{ p.schedule }}</p>
                <p class="footnote text-gray-600">{{ p.schedule.date }}</p>
              </div>
              <span class="body text-blue-600 font-semibold">
                Rp {{ p.price|floatformat:0 }}
              </span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="body text-gray-600">Belum ada harga yang diatur.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const scheduleSelect = document.getElementById("id_schedule");
    const priceInput = document.getElementById("id_price");
    const saveBtn = document.getElementById("save-btn");
    const editBtn = document.getElementById("edit-btn");
    const priceListContainer = document.getElementById("price-list-container");

    // Reset button states
    function resetButtons() {
      saveBtn.disabled = true;
      editBtn.disabled = true;
      saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      editBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }

    // Enable save button only
    function enableSaveOnly() {
      saveBtn.disabled = false;
      editBtn.disabled = true;
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      editBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }

    // Enable edit button only
    function enableEditOnly() {
      saveBtn.disabled = true;
      editBtn.disabled = false;
      saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
      editBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    // Initial state: both disabled until schedule selected
    resetButtons();

    // Cek apakah event sudah punya harga
    scheduleSelect.addEventListener('change', function () {
      const scheduleId = this.value;
      if (!scheduleId) {
        resetButtons();
        priceInput.value = "";
        return;
      }

      fetch(`/ticketing/get-price/${scheduleId}/`)
        .then(res => res.json())
        .then(data => {
          if (data.price > 0) {
            priceInput.value = data.price;
            enableEditOnly();
          } else {
            priceInput.value = "";
            enableSaveOnly();
          }
        })
        .catch(err => {
          console.error('Error fetching price:', err);
          priceInput.value = "";
          enableSaveOnly();
        });
    });

    // Fungsi simpan harga baru atau edit harga
    function submitPrice() {
      const scheduleId = scheduleSelect.value;
      const price = priceInput.value;

      if (!scheduleId) {
        alert('Silakan pilih jadwal terlebih dahulu.');
        return;
      }

      if (!price || isNaN(price) || parseFloat(price) <= 0) {
        alert('Silakan masukkan harga yang valid.');
        return;
      }

      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      // Disable buttons during submit
      saveBtn.disabled = true;
      editBtn.disabled = true;

      fetch("/ticketing/set-price-ajax/", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest",
        },
        body: new URLSearchParams({
          schedule_id: scheduleId,
          price: price,
        }),
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Update price list container
            priceListContainer.innerHTML = data.html;

            // Show success message
            const messageText = data.created ? 'Harga berhasil disimpan!' : 'Harga berhasil diperbarui!';
            showSuccessMessage(messageText);

            // After save/edit, switch to edit mode for this schedule
            enableEditOnly();
          } else {
            alert(data.error || 'Terjadi kesalahan.');
            // Re-enable appropriate button
            if (priceInput.value) {
              enableEditOnly();
            } else {
              enableSaveOnly();
            }
          }
        })
        .catch(err => {
          console.error('Error:', err);
          alert('Terjadi kesalahan saat menyimpan harga.');
          // Re-enable appropriate button
          if (priceInput.value) {
            enableEditOnly();
          } else {
            enableSaveOnly();
          }
        });
    }

    // Show success message
    function showSuccessMessage(message) {
      const messagesContainer = document.getElementById('messages-container');
      if (messagesContainer) {
        messagesContainer.innerHTML = `
        <ul class="mb-4 space-y-2">
          <li class="p-4 rounded-lg bg-green-100 text-green-700 body">
            ${message}
          </li>
        </ul>
      `;
        // Auto-hide after 3 seconds
        setTimeout(() => {
          messagesContainer.innerHTML = '';
        }, 3000);
      }
    }

    saveBtn.addEventListener("click", submitPrice);
    editBtn.addEventListener("click", submitPrice);
  });
</script>

{% endblock %}