{% extends 'base.html' %}
{% load static %}
{% block title %}Detail Tiket - {{ ticket.schedule }}{% endblock %}

{% block content %}
<div class="container mx-auto mt-12 px-4 pb-20">

  <!-- Back Button (Floating) -->
  <div class="max-w-3xl mx-auto mb-6 flex justify-between items-center">
    <a href="{% url 'ticket_list' %}"
      class="group flex items-center gap-2 text-[var(--neutral-600)] hover:text-[var(--pacil-blue-base)] transition-colors font-medium">
      <div
        class="p-2 bg-white rounded-lg shadow-sm group-hover:shadow-md transition-all border border-gray-100 group-hover:border-[var(--pacil-blue-lighter-2)]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd" />
        </svg>
      </div>
      <span>Kembali ke Riwayat</span>
    </a>
  </div>

  <div
    class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-[var(--neutral-100)] transform transition-all hover:shadow-2xl duration-500">

    <!-- Premium Header -->
    <div
      class="bg-gradient-to-r from-[var(--pacil-blue-darker-2)] to-[var(--pacil-blue-base)] p-8 md:p-10 text-center relative overflow-hidden">
      <div class="absolute top-0 right-0 -mr-8 -mt-8 w-40 h-40 bg-white opacity-10 rounded-full blur-3xl"></div>
      <div class="absolute bottom-0 left-0 -ml-8 -mb-8 w-32 h-32 bg-white opacity-10 rounded-full blur-3xl"></div>

      <div class="relative z-10">
        <h1 class="h3 font-bold text-white mb-2">Detail Tiket</h1>
        <p class="text-white/80 text-sm">Informasi lengkap tentang tiket pertandingan Anda</p>
      </div>
    </div>

    <!-- Ticket Content -->
    <div class="p-8 md:p-10">

      <div class="text-center mb-10">
        <h2 class="text-2xl md:text-3xl font-extrabold text-[var(--neutral-900)] mb-3 leading-tight">
          {{ ticket.schedule }}
        </h2>
        <div class="inline-flex items-center gap-2 bg-blue-50 px-5 py-2.5 rounded-2xl border border-blue-100">
          <span class="text-xs font-bold text-[var(--pacil-blue-darker-1)] uppercase tracking-wide">Total Harga</span>
          <span class="text-2xl font-bold text-[var(--pacil-blue-base)]">
            Rp {{ ticket.price|floatformat:0 }}
          </span>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50/80 rounded-2xl p-6 border border-gray-100 mb-10">
        <!-- Status Pembayaran -->
        <div class="space-y-2">
          <span class="text-xs uppercase tracking-wider font-bold text-[var(--neutral-500)] ml-1">Status
            Pembayaran</span>
          <div>
            {% if ticket.payment_status == 'paid' %}
            <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-green-100 shadow-sm">
              <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center text-green-600">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <span class="font-bold text-green-700">Sudah Dibayar</span>
            </div>
            {% else %}
            <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-yellow-100 shadow-sm">
              <div class="w-8 h-8 rounded-lg bg-yellow-100 flex items-center justify-center text-yellow-600">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <span class="font-bold text-yellow-700">{{ ticket.get_payment_status_display }}</span>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Status Penggunaan -->
        <div class="space-y-2">
          <span class="text-xs uppercase tracking-wider font-bold text-[var(--neutral-500)] ml-1">Status
            Penggunaan</span>
          <div>
            {% if ticket.is_used %}
            <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-blue-100 shadow-sm">
              <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <span class="font-bold text-blue-700">Sudah Digunakan</span>
            </div>
            {% else %}
            <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-gray-200 shadow-sm">
              <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                </svg>
              </div>
              <span class="font-bold text-gray-700">Belum Digunakan</span>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Tanggal Pembelian -->
        <div class="space-y-1 md:col-span-2 border-t border-gray-200 pt-4 mt-2">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <span class="text-xs uppercase tracking-wider font-bold text-[var(--neutral-500)]">Tanggal
                Pembelian</span>
              <p class="font-semibold text-[var(--neutral-800)] mt-1">{{ ticket.purchase_date|date:"d F Y, H:i" }}</p>
            </div>

            {% if ticket.used_at %}
            <div class="text-left md:text-right">
              <span class="text-xs uppercase tracking-wider font-bold text-[var(--neutral-500)]">Waktu Digunakan</span>
              <p class="font-semibold text-[var(--neutral-800)] mt-1">{{ ticket.used_at|date:"d F Y, H:i" }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      {% if ticket.payment_status == 'paid' %}
      <!-- Premium QR Code Section -->
      <div class="flex flex-col items-center justify-center mb-8 animate-fade-in-up">
        <div class="relative group">
          <div
            class="absolute -inset-1 bg-gradient-to-r from-[var(--pacil-blue-base)] to-blue-400 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200">
          </div>
          <div class="relative bg-white p-4 rounded-xl shadow-xl border border-gray-100">
            <img id="qrImage" alt="QR Code Tiket" style="width:240px; height:240px; display:none;" class="rounded-lg" />
            <div id="qr-placeholder"
              class="w-[240px] h-[240px] bg-gray-50 rounded-lg animate-pulse flex items-center justify-center text-gray-400">
              <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 opacity-30" fill="none"
                  viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 4v1m6 11h2m-6 0h-2v4h-4v-4H8m13-4V4H5v7m0 4v5h5v-5h4m4-4h5" />
                </svg>
                <span class="text-xs font-medium">Memuat QR...</span>
              </div>
            </div>
          </div>
        </div>
        <div
          class="mt-6 flex items-center gap-2 text-sm font-medium text-[var(--neutral-600)] bg-blue-50/50 px-4 py-2 rounded-full border border-blue-100/50">
          <svg class="w-4 h-4 text-[var(--pacil-blue-base)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Tunjukkan QR ini kepada petugas saat check-in
        </div>
      </div>
      {% endif %}

      <div class="flex flex-col md:flex-row gap-4 justify-center pt-4 border-t border-gray-100">

        {% if ticket.payment_status != 'paid' %}
        <a href="{% url 'ticket_payment' ticket.id %}"
          class="btn w-full md:w-auto px-10 py-4 rounded-xl font-bold text-white shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center gap-3 text-lg"
          style="background: linear-gradient(135deg, var(--pacil-blue-base) 0%, var(--pacil-blue-darker-1) 100%);">
          <span>Lanjutkan Pembayaran</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z"
              clip-rule="evenodd" />
          </svg>
        </a>
        {% endif %}

        {% if ticket.payment_status == 'paid' and not ticket.is_used %}
        <a href="{% url 'ticket_scan' ticket.id %}"
          class="btn w-full md:w-auto px-8 py-3 rounded-xl font-bold border-2 border-[var(--pacil-blue-base)] text-[var(--pacil-blue-base)] hover:bg-blue-50 transition-all duration-300 flex items-center justify-center gap-2 shadow-sm hover:shadow-md">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span>Scan Tiket</span>
        </a>
        {% endif %}

        {% if ticket.payment_status == 'paid' and ticket.is_used %}
        <div
          class="px-8 py-3 bg-gray-100 rounded-xl text-gray-500 font-bold border-2 border-gray-200 flex items-center gap-2 cursor-not-allowed opacity-75">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
              clip-rule="evenodd" />
          </svg>
          Tiket sudah digunakan
        </div>
        {% endif %}

      </div>
    </div>

  </div>
</div>

{% if ticket.payment_status == 'paid' %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetch(`/ticketing/generate_qr/{{ ticket.id }}/`)
      .then(response => response.json())
      .then(data => {
        const img = document.getElementById("qrImage");
        const placeholder = document.getElementById("qr-placeholder");

        if (data.qr_code) {
          img.src = "data:image/png;base64," + data.qr_code;
          img.onload = () => {
            img.style.display = "block";
            placeholder.style.display = "none";
          };
        } else {
          console.error("QR code kosong:", data);
          placeholder.innerHTML = "<span class='text-xs text-red-500'>Gagal memuat QR</span>";
        }
      })
      .catch(err => {
        console.error("Gagal fetch:", err);
        const placeholder = document.getElementById("qr-placeholder");
        if (placeholder) placeholder.innerHTML = "<span class='text-xs text-red-500'>Error koneksi</span>";
      });
  });
</script>
<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translate3d(0, 20px, 0);
    }

    to {
      opacity: 1;
      transform: translate3d(0, 0, 0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out forwards;
  }
</style>
{% endif %}

{% endblock %}