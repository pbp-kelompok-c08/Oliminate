{% extends 'base.html' %}
{% load static %}

{% block title %}Riwayat Tiket{% endblock %}

{% block content %}
<div class="container mx-auto mt-10 px-4 pb-20">

  <!-- Header Section -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
    <div>
      <h1 class="h3 font-bold text-[var(--pacil-blue-darker-2)]">Riwayat Tiket</h1>
      <p class="body text-[var(--neutral-500)] mt-1">Kelola dan pantau tiket pertandingan Anda.</p>
    </div>
    <a href="{% url 'buy_ticket' %}"
      class="btn btn-primary shadow-lg hover:shadow-xl transform transition-all duration-300 hover:-translate-y-1 flex items-center gap-2"
      style="text-decoration: none;">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
          d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
          clip-rule="evenodd" />
      </svg>
      Beli Tiket Baru
    </a>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div class="mb-8 space-y-3">
    {% for message in messages %}
    <div class="p-4 rounded-xl border flex items-center gap-3 shadow-sm animate-fade-in
          {% if message.tags == 'error' %} bg-red-50 border-red-200 text-red-700
          {% elif message.tags == 'success' %} bg-green-50 border-green-200 text-green-700
          {% else %} bg-blue-50 border-blue-200 text-blue-700 {% endif %}" role="alert">
      <span class="font-medium text-sm">{{ message }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Filters Section -->
  <div class="bg-white p-6 rounded-2xl shadow-sm border border-[var(--neutral-100)] mb-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">

      <!-- Payment Status Filter -->
      <div>
        <label for="payment_status"
          class="block text-xs font-bold text-[var(--neutral-500)] uppercase tracking-wider mb-2">
          Status Pembayaran
        </label>
        <div class="relative">
          <select name="payment_status" id="payment_status"
            class="w-full appearance-none bg-[var(--neutral-50)] border border-[var(--neutral-300)] text-[var(--neutral-900)] text-sm rounded-xl focus:ring-2 focus:ring-[var(--pacil-blue-lighter-2)] focus:border-[var(--pacil-blue-base)] block p-3 pr-10 transition-all cursor-pointer hover:bg-white hover:border-[var(--pacil-blue-base)]">
            <option value="all" {% if payment_status == 'all' %}selected{% endif %}>Semua Status</option>
            <option value="paid" {% if payment_status == 'paid' %}selected{% endif %}>Sudah Dibayar</option>
            <option value="unpaid" {% if payment_status == 'unpaid' %}selected{% endif %}>Belum Dibayar</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-[var(--neutral-500)]">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Usage Status Filter -->
      <div>
        <label for="usage_status"
          class="block text-xs font-bold text-[var(--neutral-500)] uppercase tracking-wider mb-2">
          Status Penggunaan
        </label>
        <div class="relative">
          <select name="usage_status" id="usage_status"
            class="w-full appearance-none bg-[var(--neutral-50)] border border-[var(--neutral-300)] text-[var(--neutral-900)] text-sm rounded-xl focus:ring-2 focus:ring-[var(--pacil-blue-lighter-2)] focus:border-[var(--pacil-blue-base)] block p-3 pr-10 transition-all cursor-pointer hover:bg-white hover:border-[var(--pacil-blue-base)]">
            <option value="all" {% if usage_status == 'all' %}selected{% endif %}>Semua Status</option>
            <option value="used" {% if usage_status == 'used' %}selected{% endif %}>Sudah Digunakan</option>
            <option value="unused" {% if usage_status == 'unused' %}selected{% endif %}>Belum Digunakan</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-[var(--neutral-500)]">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Reset Filter Button -->
      <div>
        <button type="button" id="resetFilters"
          class="btn btn-outline w-full flex justify-center items-center gap-2 py-3 rounded-xl border-dashed border-2 hover:bg-[var(--neutral-50)] hover:text-[var(--pacil-blue-darker-1)] transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Reset Filter
        </button>
      </div>

    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="hidden flex justify-center items-center py-12">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--pacil-blue-base)]"></div>
  </div>

  <!-- Ticket Grid Container -->
  <div id="ticketGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    <!-- Tickets will be rendered here via JavaScript -->
  </div>

  <!-- Empty State Container -->
  <div id="emptyState" class="hidden bg-white rounded-2xl shadow-lg border border-[var(--neutral-100)] p-12 text-center max-w-lg mx-auto">
    <div class="w-20 h-20 bg-[var(--neutral-50)] rounded-full flex items-center justify-center mx-auto mb-6">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[var(--neutral-300)]" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />
      </svg>
    </div>
    <h3 class="h4 text-[var(--neutral-900)] mb-2" id="emptyStateTitle">Belum Ada Tiket</h3>
    <p class="body text-[var(--neutral-500)] mb-6" id="emptyStateMessage">Mulai dukung tim favoritmu dengan membeli tiket pertandingan sekarang!</p>
    <a href="{% url 'buy_ticket' %}" class="btn btn-primary px-8" id="emptyStateAction">Mulai Beli Tiket</a>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const paymentSelect = document.getElementById('payment_status');
  const usageSelect = document.getElementById('usage_status');
  const resetBtn = document.getElementById('resetFilters');
  const ticketGrid = document.getElementById('ticketGrid');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const emptyState = document.getElementById('emptyState');
  const emptyStateTitle = document.getElementById('emptyStateTitle');
  const emptyStateMessage = document.getElementById('emptyStateMessage');
  const emptyStateAction = document.getElementById('emptyStateAction');

  // Fetch and render tickets
  async function fetchTickets() {
    const paymentStatus = paymentSelect.value;
    const usageStatus = usageSelect.value;

    // Show loading, hide others
    loadingSpinner.classList.remove('hidden');
    ticketGrid.innerHTML = '';
    emptyState.classList.add('hidden');

    try {
      const response = await fetch(`/ticketing/json/?payment_status=${paymentStatus}&usage_status=${usageStatus}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
      });

      if (!response.ok) throw new Error('Network response was not ok');

      const data = await response.json();
      loadingSpinner.classList.add('hidden');

      if (data.tickets && data.tickets.length > 0) {
        renderTickets(data.tickets);
        emptyState.classList.add('hidden');
      } else {
        ticketGrid.innerHTML = '';
        showEmptyState(paymentStatus, usageStatus);
      }

      // Update URL without reload (for bookmarkability)
      const url = new URL(window.location);
      url.searchParams.set('payment_status', paymentStatus);
      url.searchParams.set('usage_status', usageStatus);
      window.history.replaceState({}, '', url);

    } catch (error) {
      console.error('Error fetching tickets:', error);
      loadingSpinner.classList.add('hidden');
      ticketGrid.innerHTML = '<div class="col-span-full text-center py-8 text-red-500">Gagal memuat tiket. Silakan coba lagi.</div>';
    }
  }

  function renderTickets(tickets) {
    ticketGrid.innerHTML = tickets.map((t, index) => `
      <div class="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-[var(--neutral-100)] overflow-hidden flex flex-col h-full transform hover:-translate-y-1 animate-fade-in" style="animation-delay: ${index * 0.1}s">

        <!-- Ticket Header (Gradient) -->
        <div class="bg-gradient-to-r from-[var(--pacil-blue-darker-2)] to-[var(--pacil-blue-base)] p-6 relative overflow-hidden">
          <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-2xl"></div>

          <div class="relative z-10">
            <h3 class="font-bold text-white text-lg leading-snug mb-1">${t.team1} <span class="opacity-70 font-normal text-sm mx-1">vs</span> ${t.team2}</h3>
            <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-white/20 text-white backdrop-blur-sm uppercase tracking-wider border border-white/10">
              ${t.category}
            </span>
          </div>
        </div>

        <!-- Ticket Body -->
        <div class="p-6 flex-1 flex flex-col">
          <div class="space-y-4 mb-6">
            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-[var(--pacil-blue-lighter-3)] flex items-center justify-center flex-shrink-0 text-[var(--pacil-blue-base)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
              <div>
                <p class="text-sm font-semibold text-[var(--neutral-900)]">${t.date}</p>
                <p class="text-xs text-[var(--neutral-500)]">${t.time} WIB</p>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <div class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center flex-shrink-0 text-[var(--pacil-red-base)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <div>
                <p class="text-sm font-semibold text-[var(--neutral-900)]">Lokasi</p>
                <p class="text-xs text-[var(--neutral-500)]">${t.location}</p>
              </div>
            </div>
          </div>

          <div class="mt-auto border-t border-[var(--neutral-100)] pt-4">
            <div class="flex justify-between items-center mb-4">
              <span class="text-xs font-semibold text-[var(--neutral-500)] uppercase">Harga</span>
              <span class="text-lg font-bold text-[var(--pacil-blue-darker-1)]">Rp ${t.price.toLocaleString('id-ID')}</span>
            </div>

            <div class="flex flex-wrap gap-2 mb-5">
              ${t.payment_status === 'paid' ? `
                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                  <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                  Lunas
                </span>
              ` : `
                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                  <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                  </svg>
                  Belum Bayar
                </span>
              `}

              ${t.is_used ? `
                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-[var(--pacil-blue-lighter-3)] text-[var(--pacil-blue-darker-1)] border border-[var(--pacil-blue-lighter-2)]">
                  Digunakan
                </span>
              ` : `
                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-[var(--neutral-100)] text-[var(--neutral-700)] border border-[var(--neutral-200)]">
                  Belum Dipakai
                </span>
              `}
            </div>

            <a href="/ticketing/${t.id}/"
              class="btn btn-outline w-full block text-sm font-semibold hover:shadow-md transition-all text-center">
              Lihat Detail
            </a>
          </div>
        </div>
      </div>
    `).join('');
  }

  function showEmptyState(paymentStatus, usageStatus) {
    emptyState.classList.remove('hidden');
    
    if (paymentStatus !== 'all' || usageStatus !== 'all') {
      emptyStateTitle.textContent = 'Tidak Ada Tiket';
      emptyStateMessage.textContent = 'Tidak ada tiket yang sesuai dengan filter yang Anda pilih.';
      emptyStateAction.textContent = 'Hapus Filter';
      emptyStateAction.href = '#';
      emptyStateAction.onclick = (e) => {
        e.preventDefault();
        paymentSelect.value = 'all';
        usageSelect.value = 'all';
        fetchTickets();
      };
    } else {
      emptyStateTitle.textContent = 'Belum Ada Tiket';
      emptyStateMessage.textContent = 'Mulai dukung tim favoritmu dengan membeli tiket pertandingan sekarang!';
      emptyStateAction.textContent = 'Mulai Beli Tiket';
      emptyStateAction.href = '{% url "buy_ticket" %}';
      emptyStateAction.onclick = null;
    }
  }

  // Event listeners
  paymentSelect.addEventListener('change', fetchTickets);
  usageSelect.addEventListener('change', fetchTickets);

  resetBtn.addEventListener('click', function() {
    paymentSelect.value = 'all';
    usageSelect.value = 'all';
    fetchTickets();
  });

  // Initial load
  fetchTickets();
});
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fadeIn 0.4s ease-out forwards;
  }
</style>
{% endblock %}