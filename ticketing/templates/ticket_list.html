{% extends 'base.html' %}
{% load static %}
{% block title %}Riwayat Tiket{% endblock %}

{% block content %}
<div class="container mx-auto mt-8 px-4">

  <!-- Header: Judul dan Tombol Aksi Utama -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="h3">Riwayat Tiket Saya</h1>
    <a href="{% url 'buy_ticket' %}" class="btn btn-primary w-full md:w-auto" style="text-decoration: none;">
      + Beli Tiket Baru
    </a>
  </div>

  <!-- Block untuk menampilkan pesan (error/sukses) -->
  {% if messages %}
    <div class="mb-4">
    {% for message in messages %}
      <!-- Kita asumsikan 'error' adalah 'red', 'success' adalah 'green', lainnya 'blue' -->
      <div class="p-4 rounded-lg 
        {% if message.tags == 'error' %} bg-red-50 border border-red-200 text-red-700
        {% elif message.tags == 'success' %} bg-green-50 border border-green-200 text-green-700
        {% else %} bg-blue-50 border border-blue-200 text-blue-700 {% endif %}" 
        role="alert">
        {{ message }}
      </div>
    {% endfor %}
    </div>
  {% endif %}

  <!-- Tombol Filter -->
  <div class="flex items-center gap-2 mb-4">
    <span class="body" style="font-weight: var(--font-semibold);">Filter:</span>
    
    <!-- Tombol 'Semua' -->
    <!-- 'not active_filter' berarti 'active_filter' adalah None (default) -->
    <a href="{% url 'ticket_list' %}" 
       class="btn {% if not active_filter %}btn-primary{% else %}btn-outline{% endif %} text-sm py-2 px-3"
       style="text-decoration: none;">
       Semua
    </a>
    
    <!-- Tombol 'Sudah Dibayar' -->
    <!-- '?' di href akan menambahkan query parameter ke URL saat ini -->
    <a href="?status=paid" 
       class="btn {% if active_filter == 'paid' %}btn-primary{% else %}btn-outline{% endif %} text-sm py-2 px-3"
       style="text-decoration: none;">
       Sudah Dibayar
    </a>
    
    <!-- Tombol 'Belum Dibayar' -->
    <a href="?status=unpaid" 
       class="btn {% if active_filter == 'unpaid' %}btn-primary{% else %}btn-outline{% endif %} text-sm py-2 px-3"
       style="text-decoration: none;">
       Belum Dibayar
    </a>
  </div>

  <!-- Cek jika ada tiket -->
  {% if tickets %}
    
    <!-- Wrapper untuk tabel (card style) -->
    <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        
        <!-- Table Header -->
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-4 text-left footnote" style="color: var(--neutral-700); font-weight: var(--font-semibold); text-transform: uppercase; letter-spacing: 0.5px;">
              Event
            </th>
            <th scope="col" class="px-6 py-4 text-left footnote" style="color: var(--neutral-700); font-weight: var(--font-semibold); text-transform: uppercase; letter-spacing: 0.5px;">
              Harga
            </th>
            <th scope="col" class="px-6 py-4 text-left footnote" style="color: var(--neutral-700); font-weight: var(--font-semibold); text-transform: uppercase; letter-spacing: 0.5px;">
              Status Pembayaran
            </th>
            <th scope="col" class="px-6 py-4 text-left footnote" style="color: var(--neutral-700); font-weight: var(--font-semibold); text-transform: uppercase; letter-spacing: 0.5px;">
              Status Penggunaan
            </th>
            <th scope="col" class="relative px-6 py-4">
              <!-- Kolom Aksi -->
            </th>
          </tr>
        </thead>

        <!-- Table Body -->
        <tbody class="bg-white divide-y divide-gray-200">
          {% for t in tickets %}
            <tr>
              <!-- Event & ID -->
              <td class="px-6 py-4 whitespace-nowrap">
                <p class="body" style="color: var(--neutral-900); font-weight: var(--font-semibold);">{{ t.schedule }}</p>
                <p class="footnote" style="color: var(--neutral-700);">ID Tiket: #{{ t.id }}</p>
              </td>
              
              <!-- Harga -->
              <td class="px-6 py-4 whitespace-nowrap">
                <p class="body" style="color: var(--neutral-700);">Rp {{ t.price|floatformat:0 }}</p>
              </td>

              <!-- Status Pembayaran (Badges) -->
              <td class="px-6 py-4 whitespace-nowrap">
                {% if t.payment_status == 'paid' %}
                  <span class="text-xs font-semibold inline-block py-1 px-3 rounded-full text-green-700 bg-green-100">
                    Sudah Dibayar
                  </span>
                {% else %}
                  <span class="text-xs font-semibold inline-block py-1 px-3 rounded-full text-yellow-700 bg-yellow-100">
                    {{ t.get_payment_status_display }}
                  </span>
                {% endif %}
              </td>

              <!-- Status Penggunaan (Badges) -->
              <td class="px-6 py-4 whitespace-nowrap">
                {% if t.is_used %}
                  <span class="text-xs font-semibold inline-block py-1 px-3 rounded-full text-blue-700 bg-blue-100">
                    Sudah Digunakan
                  </span>
                {% else %}
                  <span class="text-xs font-semibold inline-block py-1 px-3 rounded-full text-gray-700 bg-gray-100">
                    Belum Digunakan
                  </span>
                {% endif %}
              </td>

              <!-- Aksi (Button) -->
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <a href="{% url 'ticket_detail' t.id %}" class="btn btn-outline" style="text-decoration: none;">
                  Lihat Detail
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  {% else %}
    <!-- Kondisi jika tidak ada tiket -->
    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
      
      <!-- Pesan 'empty state' yang dinamis -->
      {% if active_filter %}
        <h2 class="h5" style="color: var(--neutral-900);">Tidak Ada Tiket</h2>
        <p class="body" style="color: var(--neutral-700); margin-top: 8px;">
          Tidak ada tiket yang cocok dengan filter "{{ active_filter }}".
        </p>
      {% else %}
        <h2 class="h5" style="color: var(--neutral-900);">Kamu Belum Punya Tiket</h2>
        <p class="body" style="color: var(--neutral-700); margin-top: 8px;">
          Semua tiket yang kamu beli akan muncul di sini.
        </p>
      {% endif %}

      <a href="{% url 'buy_ticket' %}" class="btn btn-primary mt-6" style="text-decoration: none;">
        Cari & Beli Tiket Sekarang
      </a>
    </div>
  {% endif %}

</div>
{% endblock %}

