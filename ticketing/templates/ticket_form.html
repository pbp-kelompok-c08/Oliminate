{% extends 'base.html' %}
{% load static %}
{% block title %}Beli Tiket{% endblock %}

{% block content %}
<div class="container mx-auto mt-10 px-4">
  <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
    <form method="POST" class="p-6 md:p-8 space-y-6">
      {% csrf_token %}

      <!-- Judul -->
      <h1 class="text-2xl font-semibold text-center text-gray-800 mb-4">Form Pembelian Tiket</h1>

      <!-- Pesan error/sukses -->
      {% if messages %}
        <div>
          {% for message in messages %}
            <div class="p-3 rounded-lg text-sm {% if message.tags == 'error' %}bg-red-50 border border-red-200 text-red-700{% else %}bg-blue-50 border border-blue-200 text-blue-700{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Pilih Jadwal -->
      <div>
        <label for="{{ form.schedule.id_for_label }}" class="block font-medium mb-2 text-gray-700">
          Pilih Event / Jadwal
        </label>
        {{ form.schedule }}
      </div>

      <!-- Harga Tiket -->
      <div id="price-display-wrapper" class="hidden p-3 rounded-lg bg-gray-50 border border-gray-200 flex items-center justify-between">
        <span class="text-gray-700 font-medium">Harga Tiket:</span>
        <span id="ticket-price" class="text-blue-600 font-semibold"></span>
      </div>

      <!-- Metode Pembayaran -->
      <div>
        <label class="block font-medium mb-3 text-gray-700">Metode Pembayaran</label>
        <div class="space-y-2">
          {% for radio in form.payment_method %}
            <label for="{{ radio.id_for_label }}" class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer transition-all">
              {{ radio.tag }}
              <span class="ml-2 text-gray-800 text-sm">{{ radio.choice_label }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- Tombol -->
      <div class="border-t border-gray-100 pt-4 mt-4 flex flex-col md:flex-row gap-3">
        <button type="submit" id="submit-button" class="btn btn-primary w-full md:w-auto text-center justify-center">
          Lanjut ke Pembayaran
        </button>
        <a href="{% url 'ticket_list' %}" class="btn btn-outline w-full md:w-auto text-center justify-center">
          Batal
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const scheduleSelect = document.querySelector('[name="schedule"]');
  const priceWrapper = document.getElementById("price-display-wrapper");
  const priceText = document.getElementById("ticket-price");
  const submitButton = document.getElementById("submit-button");

  if (!scheduleSelect) return;

  async function fetchPrice() {
    const scheduleId = scheduleSelect.value;
    if (scheduleId) {
      try {
        const urlTemplate = "{% url 'get_price' 0 %}".replace('0', scheduleId);
        const response = await fetch(urlTemplate);
        const data = await response.json();
        if (data.price > 0) {
          priceText.textContent = new Intl.NumberFormat('id-ID', {
            style: 'currency', currency: 'IDR', minimumFractionDigits: 0
          }).format(data.price);
          priceWrapper.classList.remove('hidden');
          submitButton.disabled = false;
        } else {
          priceText.textContent = "Harga belum diatur";
          priceWrapper.classList.remove('hidden');
          submitButton.disabled = true;
        }
      } catch (error) {
        priceText.textContent = "Error mengambil harga";
        priceWrapper.classList.remove('hidden');
        submitButton.disabled = true;
      }
    } else {
      priceWrapper.classList.add('hidden');
      submitButton.disabled = false;
    }
  }

  scheduleSelect.addEventListener("change", fetchPrice);
});
</script>
{% endblock %}
