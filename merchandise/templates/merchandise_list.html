{% extends 'base.html' %}
{% load humanize %}
{% block title %}Merchandise{% endblock %}
 
{% block content %}
<div class="container mt-2">
    <div class="flex justify-between items-center mb-6">
        <h1 class="h3">Daftar Merchandise</h1>
        {% if user.is_authenticated and user.role == 'user' %}
        <a href="{% url 'merchandise:cart_detail' %}" class="btn btn-primary">Keranjang</a>
        {% endif %}
        {% if user.is_authenticated and user.role == 'organizer' %}
        <button id="add-merchandise-btn" class="btn btn-primary">+ Tambah Merchandise</button>
        {% endif %}
    </div>

    {% if merchandises %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" style="margin-top: 1rem;">
        {% for merchandise in merchandises %}
        <div class="card merchandise-card flex flex-col" style="margin:0; display:flex; flex-direction:column; overflow:hidden; border-radius:12px; background:white;">
            {% if merchandise.image_url %}
            <img src="{{ merchandise.image_url }}" alt="{{ merchandise.name }}" loading="lazy" style="width:100%; height:200px; object-fit:contain; object-position:left; border-radius:12px 12px 0 0;">
            {% else %}
            <div style="background-color:var(--neutral-100); height:200px; display:flex; align-items:center; justify-content:center;">
                <span class="footnote">No Image</span>
            </div>
            {% endif %}

            <div style="padding:16px;">
                <h3 class="h4" style="margin-bottom:8px;">{{ merchandise.name }}</h3>
                <p class="body" style="margin-bottom:4px;">Rp {{ merchandise.price|intcomma }}</p>
                <p class="footnote" style="margin-bottom:4px;">Stock: {{ merchandise.stock }}</p>
                <p class="footnot" style="color:var(--neutral-500);">Category: {{ merchandise.category }}</p>
            </div>

            <div style="padding:0 16px 16px 16px;">
                <a href="{% url 'merchandise:merchandise_detail' merchandise.id %}" class="btn btn-outline w-full" style="margin-bottom: 8px;">Detail</a>
                {% if user.is_authenticated and user.role == 'user' %}
                {% if merchandise.stock > 0 %}
                <form method="post" action="{% url 'merchandise:cart_add_item' merchandise.id %}" style="margin-bottom: 8px;">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" value="1"> 
                    <button type="submit" class="btn btn-primary w-full">Tambah ke Keranjang</button>
                </form>
                {% else %}
                <button type="button" class="btn btn-secondary w-full" disabled style="cursor: default; opacity: 0.6;">Stok Habis</button>
                {% endif %}
                {% endif %}
                {% if user.is_authenticated and user == merchandise.organizer %}
                <div class="flex gap-2 mt-2">
                    <a href="{% url 'merchandise:merchandise_update' merchandise.id %}" class="btn btn-primary flex-1">Edit</a>
                    <button 
                        class="btn btn-danger flex-1 delete-merchandise-btn" 
                        data-delete-url="{% url 'merchandise:merchandise_delete' merchandise.id %}"
                        data-merchandise-name="{{ merchandise.name }}"
                        data-merchandise-id="{{ merchandise.id }}"
                        type="button">
                        Delete
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <p class="body">Belum ada merchandise yang tersedia.</p>
    </div>
    {% endif %}
</div>

<div id="ajax-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="card" style="width:90%; max-width:600px; padding:24px; max-height: 90vh; overflow-y: auto;">
        <h2 class="h4" style="margin-bottom:16px;" id="modal-title">Tambah Merchandise</h2>
        <div id="modal-form-content">
        </div>
    </div>
</div>

<div id="delete-confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div class="card" style="width:90%; max-width:400px; padding:24px;">
        <h2 class="h4" style="margin-bottom:16px;">Konfirmasi Hapus</h2>
        <p class="body" id="delete-merchandise-name" style="margin-bottom:24px;">
            Apakah kamu yakin ingin menghapus merchandise <strong>[Product Name]</strong>?
        </p>
        <div class="flex justify-end gap-2">
            <button id="delete-cancel-btn" class="btn btn-outline">Batal</button>
            <button id="delete-confirm-btn" class="btn btn-danger" data-delete-url="">Ya, Hapus</button>
        </div>
    </div>
</div>

<style>
.container > .grid {
    display: grid;
    gap: 1rem;
}

@media (min-width: 768px) { 
    .grid.md\:grid-cols-2 {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) { 
    .grid.lg\:grid-cols-3 {
        grid-template-columns: repeat(3, 1fr);
    }
}

.card {
    margin: 0;
    display: block;
}

.merchandise-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    transition: all 0.25s ease;
}

</style>

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const modal = document.getElementById('ajax-modal');
    const modalTitle = document.getElementById('modal-title');
    const createBtn = document.getElementById('add-merchandise-btn');
    const formContainer = document.getElementById('modal-form-content');
    const createUrl = "{% url 'merchandise:merchandise_create' %}"; // URL for creating product

    function showSuccessPopup(message) {
        modalTitle.textContent = 'Sukses';
        formContainer.innerHTML = `
            <div style="text-align:center; padding: 40px 20px;">
                <h3 class="h4" style="color: var(--pacil-blue-base); margin-bottom: 12px;">âœ… ${message}</h3>
                <p class="body">Halaman akan dimuat ulang sebentar lagi...</p>
            </div>
        `;
        modal.style.display = 'flex';
        
        setTimeout(() => {
            modal.style.display = 'none';
            window.location.reload(); 
        }, 1500);
    }

    createBtn.addEventListener('click', function() {
        modal.style.display = 'flex';
        formContainer.innerHTML = '<p class="body" style="text-align:center;">Loading form...</p>';
        
        fetch(createUrl, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            formContainer.innerHTML = html;
            setupFormSubmission();
        })
        .catch(error => {
            console.error('Error loading form:', error);
            formContainer.innerHTML = '<p class="body" style="color:red;">Error loading form. Please try again.</p>';
        });
    });

    function setupFormSubmission() {
        const form = formContainer.querySelector('form');
        if (form) {
            const modalCancelButton = form.querySelector('#modal-cancel-button');
            if (modalCancelButton) {
                modalCancelButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    modal.style.display = 'none';
                });
            }
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok && response.headers.get('content-type').includes('application/json')) {
                        return response.json();
                    }
                    if (response.ok) return response.text();
                    
                    throw new Error('Network response was not ok.');
                })
                .then(data => {
                    if (typeof data === 'string') {
                        formContainer.innerHTML = data;
                        setupFormSubmission(); 
                    } else if (data.success) {
                        showSuccessPopup('Merchandise berhasil ditambahkan!');
                    }
                })
                .catch(error => {
                    console.error('Submission error:', error);
                    alert('An unexpected error occurred during submission.');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                });
            });
        }
    }
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    
    const deleteModal = document.getElementById('delete-confirm-modal');
    const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
    const deleteCancelBtn = document.getElementById('delete-cancel-btn');
    const deleteMerchandiseName = document.getElementById('delete-merchandise-name');
    
    document.querySelectorAll('.delete-merchandise-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            const deleteUrl = this.getAttribute('data-delete-url');
            const name = this.getAttribute('data-merchandise-name');
            const id = this.getAttribute('data-merchandise-id');

            deleteMerchandiseName.innerHTML = `Apakah kamu yakin ingin menghapus merchandise <strong>${name}</strong>?`;
            deleteConfirmBtn.setAttribute('data-delete-url', deleteUrl);
            deleteConfirmBtn.setAttribute('data-merchandise-id', id);
            
            deleteModal.style.display = 'flex';
        });
    });

    deleteCancelBtn.addEventListener('click', () => {
        deleteModal.style.display = 'none';
    });
    deleteModal.addEventListener('click', (e) => {
        if (e.target === deleteModal) {
            deleteModal.style.display = 'none';
        }
    });

    deleteConfirmBtn.addEventListener('click', function() {
        const deleteUrl = this.getAttribute('data-delete-url');
        const merchandiseId = this.getAttribute('data-merchandise-id');
        const originalButtonHTML = this.innerHTML;

        this.disabled = true;
        this.innerHTML = 'Menghapus...';

        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken, 
                'Content-Type': 'application/json' 
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                deleteModal.style.display = 'none';
                
                showSuccessPopup(data.message);
            } else {
                alert('Gagal menghapus produk.');
            }
        })
        .catch(error => {
            console.error('Delete Error:', error);
            alert('Terjadi kesalahan saat menghapus merchandise.');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = originalButtonHTML;
        });
    });
</script>
{% endblock %}

{% endblock %}