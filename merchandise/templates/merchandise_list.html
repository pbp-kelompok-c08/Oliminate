{% extends 'base.html' %}
{% load humanize %}
{% block title %}Merchandise{% endblock %}
 
{% block content %}
<div class="container mt-2">
    <div class="flex justify-between items-center mb-6">
        <h1 class="h3">Daftar Merchandise</h1>
        {% if user.is_authenticated and user.role == 'user' %}
        <a href="{% url 'merchandise:cart_detail' %}" class="btn btn-primary">Keranjang</a>
        {% endif %}
        {% if user.is_authenticated and user.role == 'organizer' %}
        <button id="open-merchandise-modal" class="btn btn-primary" data-target="#merchandise-modal">
            + Tambah Merchandise
        </button>
        {% endif %}
    </div>

    {% if merchandises %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" style="margin-top: 1rem;">
        {% for merchandise in merchandises %}
        <div class="card merchandise-card flex flex-col" style="margin:0; display:flex; flex-direction:column; overflow:hidden; border-radius:12px; background:white;">
            {% if merchandise.image_url %}
            <img src="{{ merchandise.image_url }}" alt="{{ merchandise.name }}" loading="lazy" style="width:100%; height:200px; object-fit:contain; object-position:left; border-radius:12px 12px 0 0;">
            {% else %}
            <div style="background-color:var(--neutral-100); height:200px; display:flex; align-items:center; justify-content:center;">
                <span class="footnote">No Image</span>
            </div>
            {% endif %}

            <div style="padding:16px;">
                <h3 class="h4" style="margin-bottom:8px;">{{ merchandise.name }}</h3>
                <p class="body" style="margin-bottom:4px;">Rp {{ merchandise.price|intcomma }}</p>
                <p class="footnote" style="margin-bottom:4px;">Stock: {{ merchandise.stock }}</p>
                <p class="footnot" style="color:var(--neutral-500);">Category: {{ merchandise.category }}</p>
            </div>

            <div style="padding:0 16px 16px 16px;">
                <a href="{% url 'merchandise:merchandise_detail' merchandise.id %}" class="btn btn-outline w-full" style="margin-bottom: 8px;">Detail</a>
                {% if user.is_authenticated and user.role == 'user' %}
                {% if merchandise.stock > 0 %}
                <form method="post" action="{% url 'merchandise:cart_add_item' merchandise.id %}" style="margin-bottom: 8px;">
                    {% csrf_token %}
                    <input type="hidden" name="quantity" value="1"> 
                    <button type="submit" class="btn btn-primary w-full">Tambah ke Keranjang</button>
                </form>
                {% else %}
                <button type="button" class="btn btn-secondary w-full" disabled style="cursor: default; opacity: 0.6;">Stok Habis</button>
                {% endif %}
                {% endif %}
                {% if user.is_authenticated and user == merchandise.organizer %}
                <div class="flex gap-2 mt-2">
                    <a href="{% url 'merchandise:merchandise_update' merchandise.id %}" class="btn btn-primary flex-1">Edit</a>
                    <a href="{% url 'merchandise:merchandise_delete' merchandise.id %}" class="btn btn-danger flex-1">Delete</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <p class="body">Belum ada merchandise yang tersedia.</p>
    </div>
    {% endif %}
</div>

<div id="merchandise-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div class="card" style="padding: 24px; max-width: 600px; width: 90%; position: relative;">
        <h2 class="h4" style="margin-top:0;">Tambah Merchandise Baru</h2>
        <div id="merchandise-form-container">
            <p>Loading form...</p>
        </div>
        <button id="close-merchandise-modal" style="position: absolute; top: 10px; right: 10px; border: none; background: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
    </div>
</div>

<style>
.container > .grid {
    display: grid;
    gap: 1rem;
}

@media (min-width: 768px) { 
    .grid.md\:grid-cols-2 {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (min-width: 1024px) { 
    .grid.lg\:grid-cols-3 {
        grid-template-columns: repeat(3, 1fr);
    }
}

.card {
    margin: 0;
    display: block;
}

.merchandise-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    transition: all 0.25s ease;
}

</style>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('merchandise-modal');
        const openButton = document.getElementById('open-merchandise-modal');
        const closeButton = document.getElementById('close-merchandise-modal');
        const formContainer = document.getElementById('merchandise-form-container');
        const createUrl = "{% url 'merchandise:merchandise_create' %}";
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        openButton.addEventListener('click', function() {
            modal.style.display = 'flex';
            
            fetch(createUrl, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' 
                }
            })
            .then(response => response.text())
            .then(html => {
                formContainer.innerHTML = html;
                setupFormSubmission(); 
            })
            .catch(error => console.error('Error loading form:', error));
        });

        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        function setupFormSubmission() {
            const form = formContainer.querySelector('form');
            if (form) {
                const modalCancelButton = form.querySelector('#modal-cancel-button');
                if (modalCancelButton) {
                    modalCancelButton.addEventListener('click', function(e) {
                        e.preventDefault(); 
                        modal.style.display = 'none'; 
                    });
                }

                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(form);
                    
                    const submitButton = form.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest', 
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    })
                    .then(response => {
                        if (response.ok && response.headers.get('content-type').includes('application/json')) {
                            return response.json();
                        }
                        return response.text().then(text => { throw new Error(text); }); // Throw error or return HTML for form with errors
                    })
                    .then(data => {
                        if (data.success) {
                            formContainer.innerHTML = `
                                <div style="text-align:center; padding: 40px 20px;">
                                    <h3 class="h4" style="color: var(--pacil-blue-base); margin-bottom: 12px;">âœ… Berhasil!</h3>
                                    <p class="body">Merchandise berhasil ditambahkan!</p>
                                    <button id="success-ok-button" class="btn btn-primary" style="margin-top: 20px;">OK</button>
                                </div>
                            `;
                            
                            document.getElementById('success-ok-button').addEventListener('click', function() {
                                modal.style.display = 'none';
                                window.location.reload(); 
                            });
                        }
                    })
                    .catch(error => {
                        if (error.message.includes('<form')) {
                            formContainer.innerHTML = error.message; 
                            setupFormSubmission(); 
                        } else {
                            console.error('AJAX Submission Error:', error);
                            alert('An unexpected error occurred.');
                            submitButton.textContent = 'Submit';
                            submitButton.disabled = false;
                        }
                    });
                });
            }
        }
    });
</script>
{% endblock %}

{% endblock %}